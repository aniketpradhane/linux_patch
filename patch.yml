---
 - name: Updating security patches on servers
   hosts: all

   handlers:

     - name: Apply_update_ubuntu
       shell: "{{ item }}"
       with_items:
           - sudo apt-get update
           - sudo apt-get upgrade
           - sudo DEBIAN_FRONTEND='noninteractive' apt-get -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' dist-upgrade

     - name: Apply_update_Centos_amzon_REHL
       shell: "{{ item }}"
       with_items:
           - sudo yum update

     - name: Reboot
       shell: sudo shutdown -r now
       async: 1
       poll: 0

     - name: wait
       local_action: wait_for port=22 host="{{ inventory_hostname }}" state=started

   tasks:
     - name: Applying packges
       local_action: shell echo "{{ inventory_hostname }}, Updated" >> /home/ec2-user/log.txt
       notify:
         - Apply_update_ubuntu
       when: ansible_distribution == 'Ubuntu' 

     - name: Applying update on CentosAndRHEL
       local_action: shell echo "{{ inventory_hostname }}, Updated" >> /home/ec2-user/log.txt
       notify:
         - Apply_update_Centos_amzon_REHL
       when: ansible_distribution == "CentOS"
 
     - meta: flush_handlers
 
     - name: Rebooting Servers
       local_action: shell echo "{{ inventory_hostname }}, Patched" >> /home/ec2-user/Patched_log
       notify:
         - Reboot
         - wait 
